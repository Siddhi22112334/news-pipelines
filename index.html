<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News Brief — Tech & Finance</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111823; --text:#e7eef7; --muted:#9db0c5; --accent:#4aa3ff;
      --red:#ff5a5a; --green:#3cc174; --yellow:#ffcc66; --chip:#1a2332; --border:#1f2a3a;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg,var(--bg),rgba(11,15,20,.92));
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .nav{ display:flex; gap:.75rem; align-items:center; padding:.8rem .9rem; max-width:1100px; margin:0 auto; }
    .nav h1{ font-size:1.05rem; margin:0; letter-spacing:.2px; }
    .tabs{ margin-left:auto; display:flex; gap:.35rem }
    .tab{
      border:1px solid var(--border); background:var(--chip); color:var(--text);
      padding:.4rem .65rem; border-radius:.6rem; cursor:pointer; font-size:.92rem;
    }
    .tab.active{ outline:2px solid var(--accent) }

    main{ max-width:1100px; margin:0 auto; padding:1rem .9rem 2.5rem }
    .controls{ display:flex; flex-wrap:wrap; gap:.6rem .8rem; align-items:center; margin:.4rem 0 1rem }
    select, input[type="search"], button{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:.48rem .6rem; border-radius:.6rem; font-size:.95rem;
    }
    label.chk{ display:flex; align-items:center; gap:.4rem; font-size:.92rem; color:var(--muted) }
    .chip{
      background:var(--chip); border:1px solid var(--border); color:var(--text);
      padding:.2rem .5rem; border-radius:.6rem; font-size:.88rem;
    }

    .grid{ display:grid; grid-template-columns:1fr; gap:.9rem }
    @media(min-width:760px){ .grid{ grid-template-columns:1fr 1fr } }
    article{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:.9rem .9rem; box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:.6rem }
    .headline{ font-weight:700; font-size:1.02rem; margin:.35rem 0 .5rem }
    .kind{ font-size:.83rem; color:var(--muted) }
    .impact{ font-weight:700; padding:.08rem .4rem; border-radius:.5rem; font-size:.83rem }
    .impact.Positive{ background:rgba(60,193,116,.15); color:var(--green) }
    .impact.Negative{ background:rgba(255,90,90,.15); color:var(--red) }
    .impact.Neutral{ background:rgba(255,204,102,.15); color:var(--yellow) }
    ul{ margin:.2rem 0 0 1rem; padding:0 }
    li{ margin:.25rem 0; color:var(--text) }
    .meta{ display:flex; gap:.6rem; align-items:center; color:var(--muted); font-size:.88rem; margin-top:.6rem }
    .meta a{ color:var(--accent); text-decoration:none; overflow-wrap:anywhere }
    .empty{ color:var(--muted); padding:2rem 0; text-align:center }
    footer{ color:var(--muted); font-size:.85rem; text-align:center; margin-top:1rem }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <h1>News Brief</h1>
      <div class="tabs">
        <button class="tab active" data-view="browse">Browse</button>
        <button class="tab" data-view="search">Search</button>
      </div>
    </div>
  </header>

  <main>
    <!-- ───────────── Browse view ───────────── -->
    <section id="browse-view">
      <div class="controls">
        <label>Date
          <select id="dateSelect" title="Pick a date"></select>
        </label>
        <label>Run
          <select id="runSelect" title="Pick a run (time)"></select>
        </label>
        <label class="chk"><input type="checkbox" id="showTech" checked> Tech</label>
        <label class="chk"><input type="checkbox" id="showFinance" checked> Finance</label>
        <label class="chk"><input type="checkbox" id="dedupeToggle" checked> Hide duplicates</label>
        <span id="count" class="chip"></span>
        <span id="tips" class="chip">Tip: use Search to query all dates</span>
      </div>
      <div class="grid" id="cards"></div>
      <div class="empty" id="empty" hidden>No stories for this selection.</div>
    </section>

    <!-- ───────────── Search view ───────────── -->
    <section id="search-view" hidden>
      <div class="controls">
        <input type="search" id="q" placeholder="Search headlines & bullets…" />
        <button id="searchBtn">Search</button>
        <label class="chk"><input type="checkbox" id="sTech" checked> Tech</label>
        <label class="chk"><input type="checkbox" id="sFin" checked> Finance</label>
        <label class="chk"><input type="checkbox" id="sDedupe" checked> Hide duplicates</label>
      </div>
      <div class="grid" id="searchCards"></div>
      <div class="empty" id="searchEmpty" hidden>No matches yet. Type a query and hit Search.</div>
    </section>

    <footer>Static viewer — reads JSON under <code>viewer/data</code>.</footer>
  </main>

  <script>
    // ---------- helpers ----------
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const decodeHTML = (s='') => {
      let out = String(s);
      for (let i=0;i<2;i++){
        const doc = new DOMParser().parseFromString('<!doctype html><body>'+out, 'text/html');
        const next = doc.body.textContent || '';
        if (next === out) break;
        out = next;
      }
      return out;
    };
    const fetchJSON = async (path) => {
      const res = await fetch(path, {cache:'no-store'});
      if (!res.ok) throw new Error('HTTP '+res.status+' for '+path);
      return await res.json();
    };
    const uniq = arr => Array.from(new Set(arr));
    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    // ---------- state ----------
    // index.json (new): { "YYYY-MM-DD": { "tech_runs":[...], "fin_runs":[...] }, ... }
    // (old) index.json: { "YYYY-MM-DD": { "tech": N, "finance": M } }
    let indexMap = {};
    let years = [];
    const yearCache = { tech:{}, finance:{} }; // per-kind, per-year maps
    // cache by date+run -> combined array (tech+fin with tags)
    const dateRunCache = {};
    let lastDate = null;
    let lastRun  = null;

    // ---------- tabs ----------
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v = btn.dataset.view;
        $('#browse-view').hidden = v !== 'browse';
        $('#search-view').hidden = v !== 'search';
      });
    });

    // ---------- init ----------
    init().catch(console.error);

    async function init(){
      try{
        indexMap = await fetchJSON('./index.json');
      }catch(e){
        console.error('Failed to load index.json', e);
        $('#empty').hidden = false;
        return;
      }
      const dates = Object.keys(indexMap).sort().reverse();
      years = uniq(dates.map(d => d.slice(0,4)));

      // Populate dates (show number of runs if available)
      $('#dateSelect').innerHTML = dates.map(d=>{
        const rec = indexMap[d] || {};
        const tRuns = Array.isArray(rec.tech_runs) ? rec.tech_runs.length : 0;
        const fRuns = Array.isArray(rec.fin_runs)  ? rec.fin_runs.length  : 0;
        const suffix = (tRuns || fRuns) ? ` (runs T:${tRuns} • F:${fRuns})`
                     : (Number.isFinite(rec.tech)||Number.isFinite(rec.finance)) ? ` (T:${rec.tech||0} • F:${rec.finance||0})`
                     : '';
        return `<option value="${d}">${d}${suffix}</option>`;
      }).join('');
      $('#dateSelect').addEventListener('change', onDateChange);

      // run dropdown wiring
      $('#runSelect').addEventListener('change', onRunChange);

      // browse toggles
      $('#showTech').addEventListener('change', ()=>render());
      $('#showFinance').addEventListener('change', ()=>render());
      $('#dedupeToggle').addEventListener('change', ()=>render());

      // search wiring
      $('#searchBtn').addEventListener('click', doSearch);
      $('#q').addEventListener('keydown', (e)=>{ if (e.key==='Enter') doSearch(); });

      // Load most recent date immediately
      await onDateChange();
    }

    // ---------- run helpers ----------
    function runsForDate(dateKey){
      const rec = indexMap[dateKey] || {};
      // union tech + fin runs if present
      const t = Array.isArray(rec.tech_runs) ? rec.tech_runs : [];
      const f = Array.isArray(rec.fin_runs)  ? rec.fin_runs  : [];
      const all = Array.from(new Set([...t, ...f])).sort(); // ascending "HH:MM"
      return all;
    }

    async function ensureYear(kind, year){
      if (yearCache[kind][year]) return;
      try{
        yearCache[kind][year] = await fetchJSON(`./data/${year}_${kind}.json`);
      }catch(e){
        yearCache[kind][year] = {}; // missing file is okay
      }
    }

    function readDay(kind, year, dateKey, runKey){
      const day = (yearCache[kind][year]||{})[dateKey];
      if (!day) return [];

      // Legacy shape: array
      if (Array.isArray(day)) return day;

      // New shape: { runs: { "HH:MM": [ ... ] } }
      const runs = day.runs || {};
      if (!runKey || runKey === 'latest'){
        const keys = Object.keys(runs).sort();
        const latest = keys[keys.length-1];
        return latest ? (runs[latest] || []) : [];
      }
      return runs[runKey] || [];
    }

    async function loadDateRun(dateKey, runKey){
      const cacheKey = `${dateKey}__${runKey||'latest'}`;
      if (dateRunCache[cacheKey]) return dateRunCache[cacheKey];

      const y = dateKey.slice(0,4);
      await Promise.all([ ensureYear('tech', y), ensureYear('finance', y) ]);

      const techArr = readDay('tech', y, dateKey, runKey).map(x => ({...x, _kind:'Tech', _date:dateKey, _run:runKey||'latest'}));
      const finArr  = readDay('finance', y, dateKey, runKey).map(x => ({...x, _kind:'Finance', _date:dateKey, _run:runKey||'latest'}));

      const combined = [...techArr, ...finArr];
      dateRunCache[cacheKey] = combined;
      return combined;
    }

    // ---------- browse events ----------
    async function onDateChange(){
      const d = $('#dateSelect').value;
      if (!d) return;

      // populate runs for this date
      const runs = runsForDate(d);
      const opts = runs.length
        ? [`<option value="latest" selected>Latest</option>`].concat(runs.map(r=>`<option value="${r}">${r}</option>`))
        : [`<option value="latest" selected>Latest</option>`];
      $('#runSelect').innerHTML = opts.join('');

      lastDate = d;
      lastRun = 'latest';
      await loadDateRun(d, lastRun);
      render();
    }

    async function onRunChange(){
      const r = $('#runSelect').value || 'latest';
      lastRun = r;
      await loadDateRun(lastDate, r);
      render();
    }

    // ---------- normalize & render ----------
    function normalizeRecords(records){
      return (records || []).map(r=>{
        const item = r.item || {};
        const review = r.review || {};
        const impact = (review.impact || 'Neutral');
        const novelty = item.novelty_hash || (item.link || '').replace(/^https?:\/\//,'');
        return {
          _kind: r._kind || 'Tech',
          _date: r._date || '',
          _run:  r._run  || 'latest',
          headline: decodeHTML(review.headline_rewrite || item.title || ''),
          bullets: Array.isArray(review.bullets) ? review.bullets.map(decodeHTML) : [],
          impact,
          source: item.link || '#',
          site: item.site_name || (item.link ? new URL(item.link).host : 'source'),
          novelty
        };
      });
    }

    async function render(){
      if (!lastDate) return;
      const wantTech = $('#showTech').checked;
      const wantFin  = $('#showFinance').checked;
      const dedupe   = $('#dedupeToggle').checked;

      const combined = await loadDateRun(lastDate, lastRun);
      let list = normalizeRecords(combined);
      list = list.filter(r=> (r._kind==='Tech' && wantTech) || (r._kind==='Finance' && wantFin));

      if (dedupe){
        const seen = new Set();
        list = list.filter(r=>{
          if (!r.novelty) return true;
          if (seen.has(r.novelty)) return false;
          seen.add(r.novelty); return true;
        });
      }

      $('#count').textContent = `${list.length} stories`;
      $('#cards').innerHTML = list.map(renderCard).join('');
      $('#empty').hidden = list.length>0;
    }

    function renderCard(r){
      const impactClass = ['Positive','Negative','Neutral','Bullish','Bearish'].includes(r.impact) ? r.impact : 'Neutral';
      const bullets = (r.bullets || []).map(b=>`<li>${b}</li>`).join('');
      const headline = r.headline || '(no headline)';
      return `<article>
        <div class="row">
          <span class="kind">${r._kind}${r._run ? ' • '+r._run : ''}</span>
          <span class="impact ${impactClass}">${impactClass}</span>
        </div>
        <h2 class="headline">${headline}</h2>
        ${bullets ? `<ul>${bullets}</ul>` : ''}
        <div class="meta">
          <a href="${r.source}" target="_blank" rel="noopener noreferrer">${r.site}</a>
        </div>
      </article>`;
    }

    // ---------- global search across all dates ----------
    async function doSearch(){
      const q = ($('#q').value || '').trim().toLowerCase();
      const wantTech = $('#sTech').checked;
      const wantFin  = $('#sFin').checked;
      const dedupe   = $('#sDedupe').checked;

      if (!q){
        $('#searchCards').innerHTML = '';
        $('#searchEmpty').hidden = false;
        return;
      }

      const allDates = Object.keys(indexMap).sort().reverse();
      const allYears = uniq(allDates.map(d=>d.slice(0,4)));

      for (const y of allYears){
        await Promise.all([ ensureYear('tech', y), ensureYear('finance', y) ]);
        await sleep(10);
      }

      let universe = [];
      for (const d of allDates){
        const y = d.slice(0,4);
        const rec = indexMap[d] || {};
        const runs = runsForDate(d);
        if (runs.length){
          for (const rk of ['latest', ...runs]){
            const techArr = readDay('tech', y, d, rk).map(x=>({...x, _kind:'Tech', _date:d, _run:rk}));
            const finArr  = readDay('finance', y, d, rk).map(x=>({...x, _kind:'Finance', _date:d, _run:rk}));
            universe.push(...techArr, ...finArr);
          }
        } else {
          // legacy (no runs)
          const techArr = readDay('tech', y, d, 'latest').map(x=>({...x, _kind:'Tech', _date:d, _run:'latest'}));
          const finArr  = readDay('finance', y, d, 'latest').map(x=>({...x, _kind:'Finance', _date:d, _run:'latest'}));
          universe.push(...techArr, ...finArr);
        }
      }

      let list = normalizeRecords(universe);
      list = list.filter(r=>{
        if (!( (r._kind==='Tech' && wantTech) || (r._kind==='Finance' && wantFin) )) return false;
        const hay = (r.headline + ' ' + (r.bullets||[]).join(' ')).toLowerCase();
        return hay.includes(q);
      });

      if (dedupe){
        const seen = new Set();
        list = list.filter(r=>{
          if (!r.novelty) return true;
          if (seen.has(r.novelty)) return false;
          seen.add(r.novelty); return true;
        });
      }

      $('#searchCards').innerHTML = list.map(renderCard).join('');
      $('#searchEmpty').hidden = list.length>0;
    }
  </script>
</body>
</html>
